#!/usr/local/bin/txr
;; Run tests on txr packages
;; In txr evaluate: (load "unit_tests.tl"),
;; or on the command line: txr unit_tests.tl

(load "test_macros.tl")

(load "ranges")
(use-package "ranges")
(pprinl "Running tests for ranges package")

(test (rrev -5..5) #R(5 -5))
(test (rrev 5..-5) #R(-5 5))
(test (rrev nil) nil)

(test (rrevp 9..0) t)
(test (rrevp 0..9) nil)
(test (rrevp nil) nil)

(test (rrev* 0..9) #R(9 0))
(test (rrev* 9..0) #R(9 0))
(test (rrev* nil) nil)

(test (rmin 4..9 9..3 -3..3 -3..-5) -5)
(test (rmin 4..9 9..3 nil -3..3 nil -3..-5) -5)

(test (rmax 4..9 9..3 -3..3 -3..-5) 9)
(test (rmax 4..9 9..3 nil -3..3 nil -3..-5) 9)

(test (rspan 4..9 9..3 -3..3 5..-5) #R(-5 9))
(test (rspan 4..9 9..3 nil -3..3 nil 5..-5) #R(-5 9))
(test (rspan 4..9) #R(4 9))

(test (rolap 0..5 6..9) left)
(test (rolap -5..5 3..9) olapl)
(test (rolap -5..10 3..9) contains)
(test (rolap 0..5 0..5) equal)
(test (rolap 1..1 1..1) equal)
(test (rolap 1..1 2..2) left)
(test (rolap 2..2 1..1) right)
(test (rolap 4..8 3..9) within)
(test (rolap 5..10 3..9) olapr)
(test (rolap 6..9 0..5) right)
(test (rolap 0..3 3..9) olapl)
(test (rolap 0..3 -5..0) olapr)

(test (rsort 4..9 9..3 -3..3 -3..-5) (#R(-5 -3) #R(-3 3) #R(3 9) #R(4 9)))
(test (rsort -3..-5 9..3 4..9 -3..3) (#R(-5 -3) #R(-3 3) #R(3 9) #R(4 9)))
(test (rsort -3..-5 nil 9..3 nil 4..9 -3..3) (#R(-5 -3) #R(-3 3) #R(3 9) #R(4 9) nil nil))
(test (rsort -3..-5) (#R(-5 -3)))

(test (runi -3..-5 9..3 4..9 -3..3) (#R(-5 9)))
(test (runi 4..9 9..3 -3..3 -3..-5) (#R(-5 9)))
(test (runi -5..5) (#R(-5 5)))
(test (runi 5..-5) (#R(-5 5)))
(test (runi -5..-3 3..5) (#R(-5 -3) #R(3 5)))
(test (runi 3..5 -5..-3) (#R(-5 -3) #R(3 5)))
(test (runi 4..9 9..3 nil -3..3 nil -3..-5) (#R(-5 9)))
(test (runi 4..9 9..3 10..10 -3..3 nil -3..-5) (#R(-5 10)))
(test (runi nil) nil)
(test (runi 1..1) (#R(1 1)))
(test (runi 1..1 2..2) (#R(1 2)))
(test (runi 1..1 nil) (#R(1 1)))
(test (runi nil 1..1) (#R(1 1)))
(test (runi nil nil) nil)

(test (risec -3..-5 9..3 4..9 -3..3) nil)
(test (risec 4..9 9..3 -3..3 -3..-5) nil)
(test (risec -5..5) #R(-5 5))
(test (risec 5..-5) #R(-5 5))
(test (risec -5..5 3..10) #R(3 5))
(test (risec 3..10 -5..5 4..5) #R(4 5))
(test (risec 3..10 -5..5 nil 4..5) nil)
(test (risec 1..1) #R(1 1))
(test (risec 3..10 -5..5 4..4 4..5) #R(4 4)) 
(test (risec nil) nil)
(test (risec nil nil) nil)
(test (risec nil 1..1) nil)

(test (rdiff -7..0 -3..-5 9..3 4..9 -3..3) ((#R(-7 -6)) #R(1 9)))
(test (rdiff (list -3..-5 9..3 4..9 -3..3) -7..0) ((#R(1 9)) #R(-7 -6)))
(test (rdiff -5..-3 3..5) ((#R(-5 -3)) #R(3 5)))
(test (rdiff 5..3 -3..-5) ((#R(3 5)) #R(-5 -3)))
(test (rdiff 5..3 nil) ((#R(3 5))))
(test (rdiff nil 3..5) (nil #R(3 5)))
(test (rdiff nil -3..-5 4..9 -3..3) (nil #R(-5 9)))
(test (rdiff (list -3..-5 4..9 -3..3) nil) ((#R(-5 9))))
(test (rdiff nil nil) (nil))
(test (rdiff 1..4 1..4) (nil))
(test (rdiff 1..1 3..3) ((#R(1 1)) #R(3 3)))
(test (rdiff 1..1 1..1) (nil))
(test (rdiff 1..1 nil) ((#R(1 1))))
(test (rdiff 1..1 nil 2..2) ((#R(1 1)) #R(2 2)))
(test (rdiff 1..1 -3..-5 nil 4..9 -3..3) (nil #R(-5 0) #R(2 9)))
(test (rdiff 1..1 -3..-5 2..2 4..9 -3..3) (nil #R(-5 0) #R(2 9)))
(test (rdiff (list -3..-5 2..2 4..9 -3..3) 1..1) ((#R(-5 0) #R(2 9))))
(test (rdiff nil nil) (nil))
(test (rdiff 1..4 2..4) ((#R(1 1))))
(test (rdiff 1..1 0..5) (nil #R(0 0) #R(2 5)))
(test (rdiff 1..1 0..5 7..7) (nil #R(0 0) #R(2 5) #R(7 7)))
(test (rdiff 0..5 1..1) ((#R(0 0) #R(2 5))))

(test (rsplit 0..10) (#R(0 10)))
(test (rsplit 0..10 0) (#R(0 10)))
(test (rsplit 0..10 10) (#R(0 10)))
(test (rsplit 0..10 -5) (#R(0 10)))
(test (rsplit 0..10 15) (#R(0 10)))
(test (rsplit 0..10 5) (#R(0 5) #R(5 10)))
(test (rsplit 0..10 '(3 5)) (#R(0 3) #R(3 5) #R(5 10)))
(test (rsplit 0..10 '(5 3)) (#R(0 3) #R(3 5) #R(5 10)))
(test (rsplit 0..10 '(3 3 5)) (#R(0 3) #R(3 5) #R(5 10)))
(test (rsplit 0..10 '(10 15 20)) (#R(0 10)))
(test (rsplit 0..10 '(0 -5 -10)) (#R(0 10)))
(test (rsplit -10..10) (#R(-10 0) #R(0 10)))
(test (rsplit 10..-10) (#R(10 0) #R(0 -10)))
(test (rsplit -10..10 '(5 0 -5)) (#R(-10 -5) #R(-5 0) #R(0 5) #R(5 10)))
(test (rsplit -10..10 '(-5 0 5)) (#R(-10 -5) #R(-5 0) #R(0 5) #R(5 10)))
(test (rsplit 0..10 5 t) (#R(0 4) #R(5 10)))
(test (rsplit 0..10 '(3 5) t) (#R(0 2) #R(3 4) #R(5 10)))
(test (rsplit 10..0 5 t) (#R(10 6) #R(5 0)))
(test (rsplit 10..-10 0 t) (#R(10 1) #R(0 -10)))
(test (rsplit 5..5) (#R(5 5)))
(test (rsplit -5..-5) (#R(-5 -5)))
(test (rsplit 0..0) (#R(0 0)))

(test (listr nil) nil)
(test (listr '(nil)) nil)
(test (listr '(nil nil)) nil)
(test (listr (rlist 0..10)) (#R(0 10)))
(test (listr (list 0..10)) (#R(0 10)))
(test (listr (rlist 10..0)) (#R(10 0)))
(test (listr (list 10..0)) (#R(10 0)))
(test (listr (rlist -5..0)) (#R(-5 0)))
(test (listr (list -5..0)) (#R(-5 0)))
(test (listr (rlist 0..-5)) (#R(0 -5)))
(test (listr (list 0..-5)) (#R(0 -5)))
(test (listr (nconc (rlist 0..5) (rlist 0..-5))) (#R(0 5) #R(0 -5)))
(test (listr (list 0..5 0..-5)) (#R(0 5) #R(0 -5)))
(test (listr (list 0..-5 0..5)) (#R(0 -5) #R(0 5)))
(test (listr (nconc (rlist -5..5) (rlist 10..3))) (#R(-5 5) #R(10 3)))
(test (listr (list -5..5 10..3)) (#R(-5 5) #R(10 3)))
(test (listr '(0)) (#R(0 0)))
(test (listr '(0 4 2 9 5)) (#R(0 0) #R(4 4) #R(2 2) #R(9 9) #R(5 5)))
(test (listr '(0 1 2 4 3 2 9 9 9 8 7 0 -1 -2)) (#R(0 2) #R(4 2) #R(9 9) #R(9 9) #R(9 7) #R(0 -2)))
(test (listr (list 4 5..5)) (#R(4 5)))
(test (listr (list 5..5 4)) (#R(5 4)))
(test (listr (list 9..6 5..5)) (#R(9 5)))
(test (listr (list -9..-6 -5..-5)) (#R(-9 -5)))
(test (listr (list 2..4 5..5)) (#R(2 5)))
(test (listr (list -2..-4 -5..-5)) (#R(-2 -5)))

(test (listr* nil) nil)
(test (listr* '(nil)) nil)
(test (listr* '(nil nil)) nil)
(test (listr* (rlist 0..10)) (#R(0 11)))
(test (listr* (list 0..10)) (#R(0 10)))
(test (listr* (rlist 5..0)) (#R(5 6) #R(4 5) #R(3 4) #R(2 3) #R(1 2) #R(0 1)))
(test (listr* (list 5..0)) (#R(5 6) #R(4 5) #R(3 4) #R(2 3) #R(1 2)))
(test (listr* (rlist -5..0)) (#R(-5 0) #R(0 1)))
(test (listr* (list -5..0)) (#R(-5 0)))
(test (listr* (rlist 0..-5)) (#R(0 1) #R(-1 0) #R(-2 -1) #R(-3 -2) #R(-4 -3) #R(-5 -4)))
(test (listr* (list 0..-5)) (#R(0 1) #R(-1 0) #R(-2 -1) #R(-3 -2) #R(-4 -3)))
(test (listr* (nconc (rlist 0..2) (rlist 0..-2))) (#R(0 3) #R(0 1) #R(-1 0) #R(-2 -1)))
(test (listr* (list 0..2 0..-2)) (#R(0 2) #R(0 1) #R(-1 0)))
(test (listr* (list 0..-2 0..2)) (#R(0 1) #R(-1 0) #R(0 2)))
(test (listr* (nconc (rlist -5..5) (rlist 5..3))) (#R(-5 0) #R(0 6) #R(5 6) #R(4 5) #R(3 4)))
(test (listr* (list -5..5 5..3)) (#R(-5 0) #R(0 5) #R(5 6) #R(4 5)))
(test (listr* '(0)) (#R(0 1)))
(test (listr* '(0 4 2 9 5)) (#R(0 1) #R(4 5) #R(2 3) #R(9 10) #R(5 6)))
(test (listr* (list -1..-1 0..0 1..1)) ())
(test (listr* (list 4 5..5)) (#R(4 5)))
(test (listr* (list 5..5 4)) (#R(4 5)))
(test (listr* (list -9..-6 -5..-5)) (#R(-9 -6)))
(test (listr* (list 2..4 5..5)) (#R(2 4)))
(test (listr* (list -2..-4 -5..-5)) (#R(-2 -1) #R(-3 -2)))


(test (slice-list (range 0 10) (range 0 10 2)) (0 2 4 6 8 10))
(test (slice-list (range 0 10) (range 1 10 2)) (1 3 5 7 9))
(test (slice-list (range 0 10) 0..5) (0 1 2 3 4 5))
(test (slice-list (range 0 10) 5..0) (5 4 3 2 1 0))
(test (slice-list (range 0 10) -2..0) (9 10 0))
(test (slice-list (range 0 10) 0..-2) (0 10 9))
(test (slice-list (range 0 10) -3..3) (8 9 10 0 1 2 3))
(test (slice-list (range 0 10) 3..-3) (3 2 1 0 10 9 8))
(test (slice-list (range 0 10) 3) (3))
(test (slice-list (range 0 10) -3) (8))
(test (slice-list (range 0 10) -1) (10))
(test (slice-list (range 0 10) '(-1 1 0 -2 2 0)) (10 1 0 9 2 0))
(test (slice-list (range 0 10) (list 0..3 4..8)) (0 1 2 3 4 5 6 7 8))
(test (slice-list (range 0 10) (list -3..3 3..-3)) (8 9 10 0 1 2 3 3 2 1 0 10 9 8))
(test (slice-list (range 0 10) (list 3..-3 -3..3)) (3 2 1 0 10 9 8 8 9 10 0 1 2 3))
(test (slice-list (range 0 10) (list 0 1 2 (list 3 4..10 5) 6 7 8)) (0 1 2 3 4 5 6 7 8 9 10 5 6 7 8))
(test (slice-list (range 0 10) 'evenp) (0 2 4 6 8 10))
(test (slice-list (range 0 10) (symbol-function 'evenp)) (0 2 4 6 8 10))
(test (slice-list (range 0 10) 'oddp) (1 3 5 7 9))
(test (slice-list (range 0 10) (symbol-function 'oddp)) (1 3 5 7 9))
(test (slice-list (range 0 10) (op > @1 5)) (6 7 8 9 10))

(unuse-package "ranges")

(load "csv")
(use-package "csv")
(pprinl "Running tests for csv package")

(test (read-csv-stream (make-strlist-input-stream '("c1,c2,c3" "a,b,c" "1,2,3"))).data
      (("c1" "c2" "c3") ("a" "b" "c") ("1" "2" "3")))
(test (read-csv-stream (make-strlist-input-stream '("c1,c2,c3" "a,b,c" "1,2,3"))).ncols
      3)
(test (read-csv-stream (make-strlist-input-stream '("c1,c2,c3" "a,b,c" "1,2,3"))).(nrows)
      3)
(test (read-csv-stream (make-strlist-input-stream '("c1,c2,c3" "a,b,c" "1,2,3"))).headers
      nil) 
(test (read-csv-stream (make-strlist-input-stream '("c1,c2,c3" "a,b,c" "1,2,3")) :header t).(nrows)
      2)
(test (read-csv-stream (make-strlist-input-stream '("c1,c2,c3" "a,b,c" "1,2,3")) :header t).headers
      ("c1" "c2" "c3"))
(test (read-csv-stream (make-strlist-input-stream '("c1,c2,c3" "a,b,c" "1,2,3")) :header '("h1" "h2" "h3")).ncols
      3)
(test (read-csv-stream (make-strlist-input-stream '("c1,c2,c3" "a,b,c" "1,2,3")) :header '("h1" "h2" "h3")).(nrows)
      3)
(test (read-csv-stream (make-strlist-input-stream '("c1,c2,c3" "a,b,c" "1,2,3")) :header '("h1" "h2" "h3")).headers
      ("h1" "h2" "h3"))
(test (read-csv-stream (make-strlist-input-stream '("c1,c2,c3" "a,\"b,e\",c" "1,2,\"34\""))).data
      (("c1" "c2" "c3") ("a" "\"b,e\"" "c") ("1" "2" "\"34\"")))
(test (read-csv-stream (make-strlist-input-stream '("c1,c2,c3" "a,\"b,e\",c" "1,2,\"34\"")) :unquote t).data
      (("c1" "c2" "c3") ("a" "b,e" "c") ("1" "2" "34")))
(test (read-csv-stream (make-strlist-input-stream '("c1  ,c2  ,c3  " "a,  b,c" "1,2,34  ")) :trim t).data
      (("c1" "c2" "c3") ("a" "b" "c") ("1" "2" "34")))
(test (read-csv-stream (make-strlist-input-stream '("c1,c2,c3" "a,,c" "1,2,")) :emptystr "FOO").data
      (("c1" "c2" "c3") ("a" "FOO" "c") ("1" "2" "FOO")))
(test (read-csv-stream (make-strlist-input-stream '("  c1,c2  , c3" "a,  \"b,e\"," "1,,\"34\"  "))
		       :trim t :unquote t :emptystr "FOO").data
		       (("c1" "c2" "c3") ("a" "b,e" "FOO") ("1" "FOO" "34")))

(let* ((csv1 (new (csvdata 2 '("c1" "c2") '((1 2) (2 3) (3 4))))))
  (test csv1.ncols 2)
  (test csv1.(nrows) 3)
  (test csv1.data ((1 2) (2 3) (3 4)))
  (test [csv1 0..2] ((1 2) (2 3) (3 4)))
  (test [csv1 0..2 0..1] ((1 2) (2 3) (3 4)))
  (test [csv1 0..2 'c1] ((1) (2) (3)))
  (test [csv1 0..2 "c1"] ((1) (2) (3)))  
  (test [csv1 0..2 'c2] ((2) (3) (4)))
  (test [csv1 0..2 "c2"] ((2) (3) (4)))
  (test [csv1 0..2 '(c1 c2)] ((1 2) (2 3) (3 4)))
  (test [csv1 0..2 '("c1" "c2")] ((1 2) (2 3) (3 4)))
  (test [csv1 0..2 '("c1" 'c2)] ((1 2) (2 3) (3 4)))
  (test [csv1 0..2 '("c1" 1)] ((1 2) (2 3) (3 4)))        
  )

(unuse-package "csv")
